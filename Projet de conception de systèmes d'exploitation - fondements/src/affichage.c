#include "affichage.h"
#include "stdio.h"
#include "string.h"
#include "cpu.h"
#define PORT_C 0x3D4
#define PORT_D 0x3D5

uint32_t ligne_curseur = 0;
uint32_t colonne_curseur = 0;

uint16_t *ptr_mem(uint32_t lig, uint32_t col){
  uint16_t * ptr =(uint16_t *) (0xB8000 + 2 *(lig*80 + col));
  return ptr;
}
// , uint8_t clign, uint8_t fond, uint8_t text
void ecrit_car(uint32_t lig, uint32_t col, char c, uint8_t clg, uint8_t fond, uint8_t text){
  uint16_t *ptr = ptr_mem(lig, col);
  uint8_t ascii = (uint8_t)c;
  uint8_t format = text | (fond << 4) | (clg << 7);
  *ptr =  ascii | (format << 8);

}
void efface_ecran(uint32_t l_debut, uint32_t ligne, uint32_t colonne){
  for(uint32_t lig=l_debut; lig<ligne; lig++){
    for(uint32_t col=0; col<colonne; col++){
      ecrit_car(lig, col, ' ', 1, 15, 0);
    }
  }
  place_curseur(6,0);
}
//placer le curseur à la position donnée
void place_curseur(uint32_t lig, uint32_t col){
  ligne_curseur = lig;
  colonne_curseur = col;
  // La position du curseur
  uint16_t pos_curseur = col + lig * 80;
  // envoyer la commande 0x0F sur le port de commande
  outb(0x0F, PORT_C);
  // envoyer la partie basse de la position sur le port de données
  outb(pos_curseur & 0x00FF, PORT_D);
  // envoyer la commande 0x0F sur le port de commande
  outb(0x0E, PORT_C);
  // envoyer la partie haute de la position sur le port de données
  outb((pos_curseur & 0xFF00) >> 8, PORT_D);

}



//  traiter un caractère donné :
//  l'affiche si c'est un caractère normal. ou
//  implante l'effet voulu si c'est un caractère de contrôle).
void traite_car(char c){
  // Les caractères de code ASCII 32 à 126 doivent être affichés en les plaçant
  // à la position actuelle du curseur en le déplaçant sur la position suivante
  if(c < 127 && c > 31){
    if (ligne_curseur + 1 < 25){
      ecrit_car(ligne_curseur, colonne_curseur, c, 1, 15, 0);
      if (colonne_curseur < 79){
        place_curseur(ligne_curseur, colonne_curseur + 1);
      }
      else{
        place_curseur(ligne_curseur + 1, 0);
      }
    }
    else{
      if (colonne_curseur < 79){
        ecrit_car(ligne_curseur, colonne_curseur, c, 1, 15, 0);
        place_curseur(ligne_curseur, colonne_curseur + 1);

      }
      else{
        defilement();
        place_curseur(ligne_curseur, 0);
        ecrit_car(ligne_curseur, 0, c, 1, 15, 0);
        place_curseur(ligne_curseur, 1);

      }
    }
  }
  //Les caractères de 0 à 31 et le caractère 127 sont des caractères de contrôle
  else{
    // Recule le curseur d’une colonne (si colonne !=0)
    if (c == 8){
      if (colonne_curseur != 0){
        place_curseur(ligne_curseur, colonne_curseur - 1);
      }

    }
    // Avance à la prochaine tabulation (colonnes 0, 8, 16, ..., 72, 79)
    else if (c == 9){
        if (colonne_curseur < 73){
          place_curseur(ligne_curseur, colonne_curseur + 8 - (colonne_curseur % 8));
        }
        else{
          place_curseur(ligne_curseur, 79);
        }
    }
    //Déplace le curseur sur la ligne suivante, colonne 0
    else if (c == 10){
        if (ligne_curseur < 24){
        place_curseur(ligne_curseur + 1, 0);
        }
        else{
          defilement();
          place_curseur(ligne_curseur, 0);
        }
    }
    // Efface l’écran et place le curseur sur la colonne 0 de la ligne 0
    else if (c == 12){
        efface_ecran(0, 25, 80);
        place_curseur(1, 0);
    }
    // Déplace le curseur sur la ligne actuelle, colonne 0
    else if (c == 13){
        place_curseur(ligne_curseur, 0);
    }
  }
}
void defilement(){
    // on parcourt chaque ligne en la remplaçant par la ligne suivante
    for(uint8_t i = 4; i < 24; i++) {
      //memmove(dest, source, nombre de caractere de la source)
      // caractere : 8bits, et comme notre cas sont codées sur 16 bits
      // donc une ligne contient 80 caracteres * 2 bits :
        memmove(ptr_mem(i, 0), ptr_mem(i + 1, 0), 160);
    }
      // la derniere ligne est vide:
    for(uint8_t j = 0; j < 80; j++) {
      ecrit_car(24, j, ' ', 1, 15, 0);
    }
}

void console_putbytes(char *chaine, int32_t taille) {
    uint32_t i;

    for(i = 0; i < taille; i++) {
	     traite_car(chaine[i]);
    }
}


// // void main(){
// //   uint16_t *ptr = ptr_mem(1,4);
// //   printf('%u', ptr);
// // }
